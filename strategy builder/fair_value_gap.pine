// Â© Sevenstyles

//@version=5
indicator(title="Fair Value Gaps", shorttitle="FVG", overlay=true, max_boxes_count = 200)

// Input parameters
ext = input.int(10, "Extend FVGs")
upcolor = input.color(defval = color.green, title = "Bullish color", group = "Aesthetics")
downcolor = input.color(defval = color.red, title = "Bearish color", group = "Aesthetics")
consecutive_upcolor = input.color(defval = color.new(color.blue, 15), title = "Consecutive Bullish color", group = "Aesthetics")
consecutive_downcolor = input.color(defval = color.new(color.purple, 15), title = "Consecutive Bearish color", group = "Aesthetics")

// Candle Size Filter
use_candle_filter = input.bool(true, "Filter by Candle Size", group="Candle Size Filter")
candle_multiplier = input.float(2.0, "Candle must be X times bigger", minval=1.0, step=0.1, group="Candle Size Filter")
lookback_periods = input.int(5, "Compare with previous X candles", minval=1, maxval=20, group="Candle Size Filter")

// Consecutive FVG Settings
use_consecutive = input.bool(true, "Filter for Consecutive FVGs", group="Consecutive FVG Filter")
required_consecutive = input.int(2, "Required Consecutive FVGs", minval=2, maxval=5, group="Consecutive FVG Filter", tooltip="Only show FVGs when this many consecutive FVGs of the same type (bullish/bearish) have occurred")
highlight_consecutive = input.bool(true, "Highlight Consecutive FVGs", group="Consecutive FVG Filter")

// Arrays to store boxes and their levels
var box[] bullishBoxes = array.new_box()
var float[] bullishLevels = array.new_float()
var box[] bearishBoxes = array.new_box()
var float[] bearishLevels = array.new_float()

// Variables to track consecutive FVGs
var int bullishConsecutive = 0
var int bearishConsecutive = 0
var bool lastWasBullish = false
var bool lastWasBearish = false

// Function to check if candle is significantly larger than previous candles
is_significant_candle(index) =>
    current_size = math.abs(high[index] - low[index])
    avg_prev_size = 0.0
    for i = 1 to lookback_periods
        avg_prev_size += math.abs(high[index + i] - low[index + i])
    avg_prev_size := avg_prev_size / lookback_periods
    not use_candle_filter or current_size >= (avg_prev_size * candle_multiplier)

// FVG Detection with filters
bfvg = low > high[2] and is_significant_candle(2)
sfvg = high < low[2] and is_significant_candle(2)

// Update consecutive counters with type checking
if bfvg and lastWasBullish
    bullishConsecutive := bullishConsecutive + 1
else if bfvg
    bullishConsecutive := 1
else
    bullishConsecutive := 0

if sfvg and lastWasBearish
    bearishConsecutive := bearishConsecutive + 1
else if sfvg
    bearishConsecutive := 1
else
    bearishConsecutive := 0

// Update last FVG type
lastWasBullish := bfvg
lastWasBearish := sfvg

// Create new FVG boxes
if bfvg and (not use_consecutive or bullishConsecutive >= required_consecutive)
    color boxColor = highlight_consecutive and bullishConsecutive >= required_consecutive ? consecutive_upcolor : upcolor
    box newBox = box.new(left = bar_index-2, top = low, right = bar_index + ext, bottom = high[2], 
         border_color = color.new(color.gray, 100), bgcolor = boxColor)
    array.push(bullishBoxes, newBox)
    array.push(bullishLevels, high[2])  // Store the bottom level of bullish FVG

if sfvg and (not use_consecutive or bearishConsecutive >= required_consecutive)
    color boxColor = highlight_consecutive and bearishConsecutive >= required_consecutive ? consecutive_downcolor : downcolor
    box newBox = box.new(left = bar_index-2, top = high, right = bar_index + ext, bottom = low[2], 
         border_color = color.new(color.gray, 100), bgcolor = boxColor)
    array.push(bearishBoxes, newBox)
    array.push(bearishLevels, low[2])  // Store the top level of bearish FVG

// Check for invalidation and remove boxes
if array.size(bullishBoxes) > 0
    for i = array.size(bullishBoxes) - 1 to 0
        box currentBox = array.get(bullishBoxes, i)
        float level = array.get(bullishLevels, i)
        if close < level  // Price closed below the FVG
            box.delete(currentBox)
            array.remove(bullishBoxes, i)
            array.remove(bullishLevels, i)
        else
            box.set_right(currentBox, bar_index + ext)  // Extend active boxes

if array.size(bearishBoxes) > 0
    for i = array.size(bearishBoxes) - 1 to 0
        box currentBox = array.get(bearishBoxes, i)
        float level = array.get(bearishLevels, i)
        if close > level  // Price closed above the FVG
            box.delete(currentBox)
            array.remove(bearishBoxes, i)
            array.remove(bearishLevels, i)
        else
            box.set_right(currentBox, bar_index + ext)  // Extend active boxes